

## Приложения для установки
* Node.js
* npm
* newman
* postman (optional)
----------------------

1. [Подготовка среды. Установка необходимых приложений](#installation)
2. [Подготовка файлов для загрузки](#testfiles)
3. [Условия запуска тестов](#condition)
4. [Содержание тестов](#tests_contains)
    * [Тесты на загрузку файлов](#tests_upload)
    * [Тесты для проверок, не вошедших в основной пул](#upload_file_iteration)
5. [Перечисление всех проверок](#tests)

### <a name="installation"></a> Подготовка среды в linux (Ubuntu, linux mint)

Для пакетной установки всех файлов перейдите в директорию с проектом и запустите в консоли:
```
env.sh
```
Этот скрипт установит все программы из списка. Чтобы установить программы отдельно, установите:

**node.js**
```
sudo apt install nodejs
```

**npm**

```
sudo apt install -g npm
```

**newman**

Находясь в директории проекта запустите:

```
npm init
```

Для newman я использовала newman-reporter-html отображения отчетов.

```
sudo npm install -g newman-reporter-html
```

**Postman**
Есть несколько способов поставить Postman. Один из них с помощью snap. Для этого сначала поставим snap
```
sudo install snap
```
А затем и сам Postman

```
sudo snap install postman
```
Postman можно установить и [другим способом](https://learning.getpostman.com/docs/postman/launching_postman/installation_and_updates/#linux-installation).

### <a name="testfiles"></a> Подготовка файлов для загрузки

Все файлы для прогона тестов с помощью коллекции ***YADisk_upload_file.postman_collection.json*** хранятся в папке files. Если путь к папке и/или название папке меняется, необходимо внести корректировки в файл "dev.postman_environment.json". Путь меняем в значении ключа "value" в блоке с ключом "folder_path".

```
{
  "key": "folder_path",
  "value": "files/",
  "description": "",
  "enabled": true
}
```
В файле с данными (upload_data.json, data_long_wait_and_large_files.csv) можно добавлять и/или менять названия файлов в случае их изменения и/или добавления в папку "files".

Для запуска тестов c помощью коллекции ***YADisk_upload_file_iteration.postman_collection.json*** необходимо создать файлы больших размеров. В данном случае, файлы:

--  ***9_99GbTestData.png*** размером 9,99ГБ
-- ***2GbTestData.png*** размером 2ГБ

В Linux можно воспользоваться командой:
```
fallocate -l 2G files/2GbTestData.png; fallocate -l 10229M files/9_99GbTestData.png
```
### <a name="condition"></a> Условия запуска тестов
Все тесты можно запускать с помощью newman с обязательным указанием окружения и данных для тестов.

Файл с данными об окружении ***"dev.postman_environment.json"*** содержит значения заголовков, токен, путь до папки с файлами для загрузки.

Формат и содержание данных для тестов можно найти в разделах с описанием соответствующих коллекций.

Команда для запуска должна выглядеть следущим образом:

newman run <название коллекции> -e <файл с окружением> -d <файл с данными для коллекции>

Пример запуска тестов через newman(из директории, где лежат коллекции):
```
newman run YADisk_upload_file.postman_collection.json -e dev.postman_environment.json -d upload_data.json
```
Перед запуском каждой коллекции необходимо запустить очистку диска от данных. Для этого запускаем коллекцию "YADisk_delete_before_running_the_scripts.postman_collection.json". Например, в newman
```
newman run YADisk_delete_before_running_the_scripts.postman_collection.json -e dev.postman_environment.json
```

### <a name="tests_contains"></a> Содержание тестов
**<a name="tests_upload"></a> YADisk_upload_file.postman_collection.json**

-- ***получение ссылки - запрос на получение ссылки для загрузки файла***

1. Папка "single iteration" - все тесты для первой итерации (без возможности изменить параметры через файл с данными):

   * To verify Users Ya Disk - проверка, что ЯДиск пуст при первой итерации. При последующих перенаправление на один из запросов в папке "loop get links with different data" в зависимости от подаваемых данных)
   * To get test link for upload - проверка стандартного запроса на получение ссылки для "test.txt" без дополнительных параметров
   * upload test file - загрузка файла по полученной ссылке
   * upload test file without attach - отправка запроса по полученной ссылке без вложения
   * To get link without token - отправка запроса на получение ссылки без токена
   * To get link with invalid token - отправка запроса на получение ссылки с невалидным токеном
   * To get link without headers - отправка запроса на получение ссылки без обязательных заголовков (Accept, Content-Type)
   * To get link with wrong/xml headers - отравка запроса на получение ссылки с невалидными значениями в заголовках (xml вместо json)
   * To get link without required filds - отправка запроса на получение ссылки без обязательных полей

2. Папка "loop get links with different data" с шаблонами запросов на получение ссылки с разными параметрами с использованием данных из файла "upload_data.json":
   * To get link with requiered param - получение ссылки с указанием обязательного параметра и проверка ответа на наличие перечисленных полей
   * To get link with overwrite param - получение ссылки с указанием необязательного параметра "overwrite" (возможность перезаписывать уже имеющийся файл) и проверка ответа на наличие перечисленных полей
   * To get link with fields param - получение ссылки с указанием необязательного параметра "fields" (перечисление полей, которые должны вернуться в ответе) и проверка наличия этих полей в ответе
   * To get link with all param - получение ссылки со всеми параметрами (обязательным - path, необязательными - overwrite, fields) и проверка наличия указанных полей в ответе

3. Upload file - отправка файла по ранее полученной ссылке на загрузку
4. To verify uploaded file - проверка наличия файла в ЯДиске после его загрузки по пути, который отправляли в запросе на получение ссылки

**Структура данных для тестов**

Файл ***upload_data.json*** в формате json может содержать следующие поля:

-- "comment" содержит комментарий к проверке. Создан исключительно для удобства понимания при прочтении файла. Данные в тестах не используются

-- "linkPath" содержит путь к файлу на ЯДиске. Может быть как относительный, так и абсолютный. По документации необходимо использовать путь в формате url.

-- "linkStatusCode" содежит ожидаемый код ответа на запрос для получения ссылки

-- "responseFields" содежит массив названия полей, которые должны присутствовать в ответе на запрос для получения ссылки

-- "method" содежит метод, который должен быть указан в поле "method" в ответе на запрос для получения ссылки. Ключ "method" можно не указывать, если предполагается, что в ответе этого поля не будет

-- "file" - название файла, который будет загружен (без указания пути к этому файлу. Путь ко всем файлам указан отдельно в environment "dev.postman_environment.json"). Ключ "file" можно не указывать, если предполагается, что ссылка не была получена при предыдущем запросе, либо ожидаемый запрос пришел с ошибкой.

-- "uploadStatusCode" содежит код ответа на запрос загрузки файла. Ключ "uploadStatusCode" можно не указывать, если предполагаемый запрос на получение ссылки содержит ошибку или ссылка отсутствует.

-- "linkPath1" содержит первую часть пути к файлу на ЯДиск в том случае, если путь длинный

-- "linkPath2" содержит вторую часть пути к файлу на ЯДиск в том случае, если путь длинный

-- "overwrite" содержит boolean значение. Ключ не указывается в случае, если планируется не передавать значение в параметрах запроса

-- "fields" содежит список полей через запятую, которые должны быть возвращены в ответе. Ключ не указывается, если не планируется передавать этот необязательный параметр в запросе.

**<a name="upload_file_iteration"></a> YADisk_upload_file_iteration.postman_collection.json**

Универсальный пул запросов для следующего вида запросов:

* проверка срока действия ссылки
* проверка загрузки больших файлов
* простая проверка на загрузку файла с минимально обязательными параметрами
* проверка запроса с отложенной отправкой (secTimeOut перед отправкой запроса)

1. To get link - запрос с обязательным параметром ("path") для получения ссылки

2. Upload file - запрос для загрузки файла с вложением

3. To verify uploaded file - запрос для проверки наличия загруженного файла на ЯДиске по пути, указанному в первом запросе


**Структура данных для тестов**

Файл ***data_long_wait_and_large_files.csv*** в формате csv, разделитель запятая. Содержит следующие данные:

-- linkPath - путь до файла в ЯДиске

-- linkStatusCode - ожидаемый код ответа на запрос ссылки

-- timeOut - boolean значение. True указывается, если нужна задержка в отправке запроса. False указывается, если задержка не нужна

-- minTimeOut - время в мин. для задержки отправки запроса. Значение не обрабатывается, если в предыдущей ячейке (timeOut) стоит false. Следовательно, если временная задержка не нужна, поле можно оставить пустым, либо проставить 0

-- secTimeOut - время в сек. для задержки отправки запроса. Значение не обрабатывается, если в предыдущей ячейке (timeOut) стоит false. Следовательно, если временная задержка не нужна, поле можно оставить пустым, либо проставить 0

-- file - название файла с расширением без пути до папки с файлом. Путь указывается отдельно в environment (dev.postman_environment.json)

-- uploadStatusCode - код ответа, который ожидается после загрузки файла


#### <a name="tests"></a> Проверки
**Основные** на загрузку файла
* простая проверка загрузки файла без дополнительных параметров (запрос с вложением без указания токена)
* проверка загрузки файла без вложения
* проверка запроса ссылки без токена
* проверка запроса с невалидным токеном
* проверка запроса без обязательных заголовков
* проверка запроса с неправильными заголовками (accept, content-type xml вместо json)
* проверка запроса без обязательного поля
* проверка абсолютного пути
* проверка относительного пути до корневой директории
* проверка относительного пути до некорневой директории (заранее создана папка test в корневой директории)
* проверка невалидного относительного пути в некорневой директории
* проверка пути незакодированного в формате url
* проверка запроса с длинным названием пути, например, 255 символов и вложением с отличным от пути названием.
* проверка запроса с длинным названием пути, например, 256 символов и вложением с другим названием.
* проверка запроса на загрузку уже имеющегося на диске файла (без указания параметра перезаписи)
* проверка запроса с пустым значением "overwrite"
* проверка запроса с overwrite = false и с указанием пути к уже существующему на диске файлу
* проверка запроса с overwrite = true и вложением с названием, не совпадающим с названием в пути до файла на ЯДиске
* проверка запроса с overwrite = true и с вложением, которое уже было загружено на YADisk ранее
* проверка запроса с overwrite невалидным значением и ранее загруженным файлом.
* проверка запроса с параметром fields = href
* проверка запроса с невалидным параметром fields  
* проверка запроса с несколькими значениями fields, одно из которых невалидно
* проверка запроса со всеми валидными параметрами (path, overwrite, fields)

**Дополнительные** на загрузку файла
* загрузка файла с небольшой задержкой после получения ссылки
* загрузка файла с задержкой в 29мин.59сек после получения ссылки
* загрузка файла с задержкой в 30мин после поулчения ссылки
* загрузка файла с задержкой в 30мин01сек после получения ссылки
* загрузка большого файла, например, 9,99ГБ
* загрузка файла, по размерам превышающего свободное пространство на ЯДиске

В случае с последним пунктом, во избежании зависимости от других тестов, можно сделать дополнительную проверку, чтобы файл грузился только тогда и только тот, который превышает место на диске, либо запустить тест отдельно, предварительно заполнив свободное пространство на диске тестовыми данными. Для этого можно воспользоваться коллекцией YADisk_test_data.postman_collection.json. В самой коллекции в тесте прописана переменная с необходимым свободным местом на диске и рекурсивной загрузкой файла до тех пор, пока пространство на диске будет меньше либо равно указанному числу. Значение переменной можно вручную поменять (число в байтах):

```
"const necessarySpace = 2147483648;"
```
